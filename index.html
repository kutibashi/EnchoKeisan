<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>延長料金カレンダー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 20px; font-size: 18px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 5px; }
    th { background-color: #f0f0f0; }
    .saturday { background-color: #e0f7fa; }
    .sunday { background-color: #ffebee; }
    input[type="number"] {
      width: 80px;
      font-size: 18px;
      text-align: right;
    }
    .controls { margin-bottom: 15px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    label { white-space: nowrap; }
    select, input[type="number"] { font-size: 18px; }
    #result { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>延長料金カレンダー</h2>

  <div class="controls">
    <label>年月:
      <input type="month" id="monthInput">
    </label>
    <div class="row">
      <label>料金単位:
        <select id="timeUnit">
          <option value="60" selected>1時間単位</option>
          <option value="30">30分単位</option>
          <option value="15">15分単位</option>
        </select>
      </label>
      <label>1時間あたり料金:
        <input type="number" id="hourlyRate" value="1000" inputmode="numeric">
      </label>
      <label>1日上限:
        <input type="number" id="dailyCap" value="5000" inputmode="numeric">
      </label>
      <label>1か月上限:
        <input type="number" id="monthlyCap" value="0" inputmode="numeric">
      </label>
    </div>
  </div>

  <div id="calendar"></div>
  <div id="result"></div>

  <script>
    const monthInput = document.getElementById("monthInput");
    const timeUnitSelect = document.getElementById("timeUnit");
    const hourlyRateInput = document.getElementById("hourlyRate");
    const dailyCapInput = document.getElementById("dailyCap");
    const monthlyCapInput = document.getElementById("monthlyCap");
    const calendarDiv = document.getElementById("calendar");
    const resultDiv = document.getElementById("result");

    // デフォルト年月を今日に設定
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    monthInput.value = `${yyyy}-${mm}`;

    // カレンダー生成
    function generateCalendar(year, month) {
      let date = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0).getDate();

      let table = "<table><tr>";
      for (let d = 0; d < 7; d++) {
        table += "<th>" + ["日","月","火","水","木","金","土"][d] + "</th>";
      }
      table += "</tr><tr>";

      for (let i = 0; i < date.getDay(); i++) {
        table += "<td></td>";
      }

      for (let d = 1; d <= lastDay; d++) {
        const dayOfWeek = new Date(year, month - 1, d).getDay();
        let cls = "";
        if (dayOfWeek === 0) cls = "sunday";
        if (dayOfWeek === 6) cls = "saturday";
        table += `<td class="${cls}">${d}<br>
          <input type="number" inputmode="numeric" min="0" value="0" onchange="calculateTotal()">単位</td>`;
        if (dayOfWeek === 6) table += "</tr><tr>";
      }

      table += "</tr></table>";
      calendarDiv.innerHTML = table;
    }

    // 合計金額計算
    function calculateTotal() {
      const hourlyRate = parseInt(hourlyRateInput.value) || 0;
      const dailyCap = parseInt(dailyCapInput.value) || 0;
      const monthlyCap = parseInt(monthlyCapInput.value) || 0;
      const unitMinutes = parseInt(timeUnitSelect.value); // 60, 30, 15

      let total = 0;
      document.querySelectorAll("#calendar input[type='number']").forEach(input => {
        let units = parseInt(input.value) || 0;
        let hours = (units * unitMinutes) / 60; // 単位 → 時間に換算
        let cost = hours * hourlyRate;
        if (dailyCap > 0 && cost > dailyCap) cost = dailyCap;
        total += cost;
      });

      if (monthlyCap > 0 && total > monthlyCap) total = monthlyCap;

      resultDiv.innerText = "合計: " + total.toLocaleString() + " 円";
    }

    // 初期表示
    const [initYear, initMonth] = monthInput.value.split("-");
    generateCalendar(initYear, initMonth);
    calculateTotal();

    // 月変更・設定変更イベント
    monthInput.addEventListener("change", () => {
      const [year, month] = monthInput.value.split("-");
      generateCalendar(year, month);
      calculateTotal();
    });
    timeUnitSelect.addEventListener("change", calculateTotal);
    hourlyRateInput.addEventListener("input", calculateTotal);
    dailyCapInput.addEventListener("input", calculateTotal);
    monthlyCapInput.addEventListener("input", calculateTotal);
  </script>
</body>
</html>
