<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>保育園延長料金計算システム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f9f9f9;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 10px;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .day {
      border: 1px solid #ccc;
      background: #fff;
      min-height: 70px;
      padding: 2px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 0.9rem;
    }
    .sunday {
      background-color: #ffe5e5;
      color: red;
    }
    .saturday {
      background-color: #e5f0ff;
      color: blue;
    }
    .holiday {
      background-color: #ffe5e5;
      color: red;
    }
    .day input {
      width: 90%;
      margin-top: 3px;
      padding: 4px;
      font-size: 0.8rem;
    }
    .cost {
      margin-top: 3px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    #summary {
      margin-top: 15px;
      font-size: 1rem;
      line-height: 1.6;
    }
    #summary strong {
      font-size: 1.2rem;
      color: #000;
    }
    #settings {
      display: none;
      margin-top: 15px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #settings label {
      display: block;
      margin: 6px 0 3px;
      font-size: 0.9rem;
    }
    #settings input {
      width: 100%;
      padding: 5px;
      font-size: 1rem;
    }
    button {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px 0;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    button:active {
      background: #0056b3;
    }

    /* 📱スマホ用レスポンシブ調整 */
    @media (max-width: 600px) {
      h1 {
        font-size: 1.2rem;
      }
      .day {
        min-height: 60px;
        font-size: 0.75rem;
      }
      .day input {
        font-size: 0.7rem;
        padding: 3px;
      }
      button {
        width: 100%;
        font-size: 1rem;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>保育園延長料金計算システム</h1>
    <button onclick="toggleSettings()">⚙️ 設定</button>
  </header>

  <div id="calendar"></div>

  <div id="summary">
    <p>合計延長料金: <strong><span id="total">0</span> 円</strong></p>
  </div>

  <div id="settings">
    <label>1時間あたり料金（円）</label>
    <input type="number" id="hourlyRate" value="250">

    <label>1日上限（円）</label>
    <input type="number" id="dailyCap" value="1250">

    <label>1か月上限（円）</label>
    <input type="number" id="monthlyCap" value="10000">

    <label>補助の日額上限（円）</label>
    <input type="number" id="dailySubsidyCap" value="450">

    <label>補助の月額上限（円）</label>
    <input type="number" id="monthlySubsidyCap" value="11260">

    <button onclick="saveSettings()">保存</button>
  </div>

  <script>
    const apiKey = "AIzaSyBLeM4k58xXuKRqh9-tuLUCeOLjF2wkrM4"; // Google APIキーを設定
    const calendarId = "japanese__ja@holiday.calendar.google.com";
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    let holidays = [];
    let hourlyRate = 250;
    let dailyCap = 1250;
    let monthlyCap = 10000;
    let dailySubsidyCap = 450;
    let monthlySubsidyCap = 11260;

    async function fetchHolidays() {
      const timeMin = new Date(year, month, 1).toISOString();
      const timeMax = new Date(year, month + 1, 0).toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}`;
      const response = await fetch(url);
      const data = await response.json();
      holidays = data.items.map(event => event.start.date);
      generateCalendar();
    }

    function generateCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      for (let date = 1; date <= lastDate; date++) {
        const cell = document.createElement("div");
        const day = new Date(year, month, date).getDay();
        const dateStr = new Date(year, month, date).toISOString().split("T")[0];

        cell.className = "day";
        if (day === 0) cell.classList.add("sunday");
        if (day === 6) cell.classList.add("saturday");
        if (holidays.includes(dateStr)) cell.classList.add("holiday");

        cell.innerHTML = `
          <div>${date}</div>
          <input type="number" min="0" placeholder="時間">
          <div class="cost"></div>
        `;
        calendar.appendChild(cell);

        const input = cell.querySelector("input");
        input.addEventListener("input", calculateTotal);
      }
    }

    function calculateTotal() {
      let total = 0;
      let subsidyTotal = 0;

      document.querySelectorAll(".day").forEach(cell => {
        const input = cell.querySelector("input");
        const costDiv = cell.querySelector(".cost");
        const hours = parseFloat(input.value) || 0;

        let cost = hours * hourlyRate;
        if (cost > dailyCap) cost = dailyCap;

        let subsidy = 0;
        if (cost > 0) {
          subsidy = Math.min(dailySubsidyCap, cost);
          subsidyTotal += subsidy;
        }

        let userCost = cost - subsidy;
        total += userCost;

        // 日ごとの料金表示（「日料金：」を削除し、金額のみ）
        costDiv.textContent = cost > 0 ? `${userCost}円` : "";
      });

      if (total > monthlyCap) total = monthlyCap;
      if (subsidyTotal > monthlySubsidyCap) subsidyTotal = monthlySubsidyCap;

      document.getElementById("total").textContent = total;
    }

    function toggleSettings() {
      const settings = document.getElementById("settings");
      settings.style.display = settings.style.display === "block" ? "none" : "block";
    }

    function saveSettings() {
      hourlyRate = parseInt(document.getElementById("hourlyRate").value) || 250;
      dailyCap = parseInt(document.getElementById("dailyCap").value) || 1250;
      monthlyCap = parseInt(document.getElementById("monthlyCap").value) || 10000;
      dailySubsidyCap = parseInt(document.getElementById("dailySubsidyCap").value) || 450;
      monthlySubsidyCap = parseInt(document.getElementById("monthlySubsidyCap").value) || 11260;
      alert("設定を保存しました");
      calculateTotal();
    }

    fetchHolidays();
  </script>
</body>
</html>
