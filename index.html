<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿è‚²åœ’å»¶é•·æ–™é‡‘è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    :root{
      --gap:10px;
      --card-bg:#fafafa;
      --border:#ccc;
      --sunday:#ffe8e8;
      --saturday:#e8f0ff;
      --text-size:16px;
      --input-font:18px;
    }
    body{font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Noto Sans JP", Arial, sans-serif;
         margin:12px; color:#111; font-size:var(--text-size);}
    h1{font-size:1.1rem; margin:6px 0 10px;}
    .row{display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap;}
    .card{background:var(--card-bg); border:1px solid var(--border); padding:10px; border-radius:6px;}
    label{font-size:0.95rem;}
    input[type="number"], input[type="month"], input[type="text"]{
      font-size: var(--input-font); padding:8px; border:1px solid var(--border);
      border-radius:4px; width:100%; box-sizing:border-box;
    }
    .controls{margin-bottom:12px;}
    .settings{display:none; margin-top:8px;}
    .controls-grid{display:flex; gap:8px; flex-wrap:wrap;}
    .controls-grid > .col{flex:1; min-width:120px;}
    button{padding:10px; font-size:16px; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer;}
    button.primary{background:#0b84ff; color:#fff; border-color:#0b84ff;}
    button.full{width:100%;}
    /* table */
    table.calendar{width:100%; border-collapse:collapse; table-layout:fixed;}
    table.calendar th, table.calendar td{border:1px solid var(--border); padding:6px; text-align:left; vertical-align:top; word-break:break-word;}
    table.calendar th{background:#f6f6f6; font-weight:600; text-align:center;}
    table.calendar td .date{font-size:0.9rem; color:#333;}
    table.calendar td .hours{display:block; margin-top:6px;}
    table.calendar td input[type="number"]{width:100%; font-size:var(--input-font); padding:6px; text-align:right;}
    .sunday{background:var(--sunday);}
    .holiday{background:var(--sunday);} /* ç¥æ—¥ã¯æ—¥æ›œè‰² */
    .saturday{background:var(--saturday);}
    /* results */
    .results{margin-top:12px; display:grid; gap:8px;}
    .result-row{display:flex; justify-content:space-between; padding:8px; background:#fff; border:1px solid var(--border); border-radius:6px;}
    .small{font-size:0.9rem; color:#666;}
    /* share area */
    #shareSection{display:none; margin-top:10px;}
    #shareCode{font-size:14px; padding:8px;}
    /* responsive tweaks */
    @media (max-width:420px){
      :root{--input-font:16px;}
      .controls-grid{flex-direction:column;}
      table.calendar th, table.calendar td{padding:4px; font-size:13px;}
    }
  </style>
</head>
<body>
  <h1>ä¿è‚²åœ’å»¶é•·æ–™é‡‘è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h1>

  <div class="card controls">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div style="flex:1; min-width:160px;">
        <label for="monthInput">è¡¨ç¤ºå¹´æœˆ</label><br>
        <input id="monthInput" type="month">
      </div>

      <div style="min-width:140px;">
        <label>&nbsp;</label><br>
        <button id="toggleSettingsBtn" onclick="toggleSettings()">âš™ï¸ è¨­å®šã‚’è¡¨ç¤º</button>
      </div>
    </div>

    <div id="settingsPanel" class="settings" aria-hidden="true" >
      <div class="controls-grid" style="margin-top:8px;">
        <div class="col">
          <label>1æ™‚é–“ã‚ãŸã‚Šæ–™é‡‘ï¼ˆå††ï¼‰</label>
          <input id="hourlyRate" type="number" inputmode="numeric" placeholder="ä¾‹: 1000">
        </div>
        <div class="col">
          <label>1æ—¥ä¸Šé™é‡‘é¡ï¼ˆå††ï¼‰</label>
          <input id="dailyCap" type="number" inputmode="numeric" placeholder="ä¾‹: 3000">
        </div>
        <div class="col">
          <label>1ã‹æœˆä¸Šé™é‡‘é¡ï¼ˆå††ï¼š0ã§ç„¡åˆ¶é™ï¼‰</label>
          <input id="monthlyCap" type="number" inputmode="numeric" placeholder="ä¾‹: 30000">
        </div>
        <div class="col">
          <label>è£œåŠ©ï¼šæ—¥é¡ä¸Šé™ï¼ˆå††ï¼‰</label>
          <input id="dailySubsidyCap" type="number" inputmode="numeric" placeholder="ä¾‹: 450">
        </div>
        <div class="col">
          <label>è£œåŠ©ï¼šæœˆé¡ä¸Šé™ï¼ˆå††ï¼‰</label>
          <input id="monthlySubsidyCap" type="number" inputmode="numeric" placeholder="ä¾‹: 11260">
        </div>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="applyDefaults" onclick="applyDefaultSettings()">æ—¢å®šå€¤ã‚’å¾©å…ƒ</button>
        <button onclick="hideSettings()">é–‰ã˜ã‚‹</button>
      </div>
      <div class="small" style="margin-top:8px;">
        â€» è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºã§ã™ã€‚å…¬é–‹ãƒšãƒ¼ã‚¸ã§ç›´æ¥ç·¨é›†ã™ã‚‹å ´åˆã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <div id="calendarContainer" class="card" style="margin-top:10px; padding:8px;">
    <div id="calendar"></div>
  </div>

  <div class="results">
    <div class="result-row"><div>å»¶é•·æ–™é‡‘åˆè¨ˆ</div><div id="totalFee">0 å††</div></div>
    <div class="result-row"><div>è£œåŠ©é‡‘åˆè¨ˆ</div><div id="totalSubsidy">0 å††</div></div>
    <div class="result-row" style="background:#fff7e6;"><div><strong>æœ€çµ‚æ”¯æ‰•é‡‘é¡</strong></div><div id="finalPayment"><strong>0 å††</strong></div></div>

    <div class="card" style="padding:8px;">
      <button id="toggleShareBtn" onclick="toggleShare()">ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
      <div id="shareSection">
        <label>å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆã‚³ãƒ”ãƒ¼å¯ / è²¼ä»˜ã‘ã§å¾©å…ƒï¼‰</label>
        <input id="shareCode" type="text" readonly>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button onclick="generateCode()" class="full">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆæœ€ä¸‹éƒ¨ã®ãƒœã‚¿ãƒ³ã¨åŒæ©Ÿèƒ½ï¼‰</button>
          <button onclick="loadFromShareInput()">è²¼ä»˜ã‘ã‹ã‚‰å¾©å…ƒ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æœ€ä¸‹éƒ¨ï¼šã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆè¦æœ›: ä¸€ç•ªä¸‹ï¼‰ -->
  <div style="margin-top:12px;">
    <button id="generateBtn" class="primary full" onclick="generateCode()">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
  </div>

  <script>
/* =======================
   è¨­å®šï¼ˆå¿…è¦ãªã‚‰ã“ã“ã‚’ç·¨é›†ï¼‰
   ======================= */
const API_KEY = "YOUR_API_KEY_HERE"; // â†ã“ã“ã‚’å–å¾—ã—ãŸGoogle APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼ˆãƒªãƒ•ã‚¡ãƒ©åˆ¶é™æ¨å¥¨ï¼‰
const CALENDAR_ID = "japanese__ja@holiday.calendar.google.com";

/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤ */
const DEFAULTS = {
  hourlyRate: 1000,
  dailyCap: 3000,
  monthlyCap: 0,         // 0 = ç„¡åˆ¶é™
  dailySubsidyCap: 450,
  monthlySubsidyCap: 11260
};

/* å†…éƒ¨çŠ¶æ…‹ */
let holidays = new Set(); // YYYY-MM-DD strings for fetched year(s)

/* è¦ç´ å‚ç…§ */
const monthInput = document.getElementById("monthInput");
const calendarDiv = document.getElementById("calendar");
const hourlyRateInput = document.getElementById("hourlyRate");
const dailyCapInput = document.getElementById("dailyCap");
const monthlyCapInput = document.getElementById("monthlyCap");
const dailySubsidyInput = document.getElementById("dailySubsidyCap");
const monthlySubsidyInput = document.getElementById("monthlySubsidyCap");

const totalFeeEl = document.getElementById("totalFee");
const totalSubsidyEl = document.getElementById("totalSubsidy");
const finalPaymentEl = document.getElementById("finalPayment");

const settingsPanel = document.getElementById("settingsPanel");
const shareSection = document.getElementById("shareSection");
const shareCodeInput = document.getElementById("shareCode");

/* åˆæœŸåŒ– */
function init(){
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹´æœˆã‚’ä»Šæ—¥ã«
  const t = new Date();
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,"0");
  monthInput.value = `${yyyy}-${mm}`;

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é©ç”¨
  applyDefaultSettings();

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  monthInput.addEventListener("change", onMonthChange);
  hourlyRateInput.addEventListener("input", calculateAll);
  dailyCapInput.addEventListener("input", calculateAll);
  monthlyCapInput.addEventListener("input", calculateAll);
  dailySubsidyInput.addEventListener("input", calculateAll);
  monthlySubsidyInput.addEventListener("input", calculateAll);

  // åˆå›æç”»
  renderForSelectedMonth();
}

function applyDefaultSettings(){
  hourlyRateInput.value = DEFAULTS.hourlyRate;
  dailyCapInput.value = DEFAULTS.dailyCap;
  monthlyCapInput.value = DEFAULTS.monthlyCap;
  dailySubsidyInput.value = DEFAULTS.dailySubsidyCap;
  monthlySubsidyInput.value = DEFAULTS.monthlySubsidyCap;
  calculateAll();
}

/* è¨­å®šãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ¶å¾¡ */
function toggleSettings(){
  const showing = settingsPanel.style.display === "block";
  settingsPanel.style.display = showing ? "none" : "block";
  document.getElementById("toggleSettingsBtn").textContent = showing ? "âš™ï¸ è¨­å®šã‚’è¡¨ç¤º" : "âš™ï¸ è¨­å®šã‚’éè¡¨ç¤º";
}
function hideSettings(){ settingsPanel.style.display = "none"; document.getElementById("toggleSettingsBtn").textContent = "âš™ï¸ è¨­å®šã‚’è¡¨ç¤º"; }

/* å…±æœ‰ã‚³ãƒ¼ãƒ‰è¡¨ç¤º */
function toggleShare(){
  const showing = shareSection.style.display === "block";
  shareSection.style.display = showing ? "none" : "block";
  document.getElementById("toggleShareBtn").textContent = showing ? "ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º" : "ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º";
}

/* æœˆå¤‰æ›´æ™‚ */
async function onMonthChange(){
  await renderForSelectedMonth();
}

/* ç¥æ—¥å–å¾—ï¼ˆAPIã‚’1å¹´åˆ†å–å¾—ï¼‰ */
async function fetchHolidaysForYear(year){
  holidays.clear();
  try {
    const timeMin = `${year}-01-01T00:00:00Z`;
    const timeMax = `${year}-12-31T23:59:59Z`;
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${encodeURIComponent(API_KEY)}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&maxResults=2500`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.status + " " + res.statusText);
    const j = await res.json();
    if (j.items && Array.isArray(j.items)){
      j.items.forEach(it=>{
        // all-day events have start.date in YYYY-MM-DD
        if (it.start && it.start.date) holidays.add(it.start.date);
      });
    }
  } catch(e){
    console.warn("ç¥æ—¥å–å¾—å¤±æ•—:", e);
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ holidays ã‚’ç©ºã«ã—ã¦é€šå¸¸ã®åœŸæ—¥ã ã‘è‰²ã‚’ä»˜ã‘ã‚‹
  }
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆå¹´æœˆã¯ monthInput.value ã® YYYY-MM å½¢å¼ï¼‰ */
async function renderForSelectedMonth(){
  const ym = monthInput.value;
  if(!ym){
    // ãªã‘ã‚Œã°ä»Šæ—¥
    const t = new Date();
    monthInput.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;
  }
  const [yStr,mStr] = monthInput.value.split("-");
  const year = parseInt(yStr,10);
  const month = parseInt(mStr,10);

  // ç¥æ—¥ã‚’å–å¾—ï¼ˆyear å…¨ä½“åˆ†ï¼‰
  await fetchHolidaysForYear(year);

  // build table
  const first = new Date(year, month-1, 1);
  const lastDay = new Date(year, month, 0).getDate();
  let html = '<table class="calendar"><thead><tr>';
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d=> html += `<th>${d}</th>`);
  html += '</tr></thead><tbody><tr>';

  // ç©ºã‚»ãƒ«
  for(let i=0;i<first.getDay();i++) html += '<td></td>';

  for(let d=1; d<=lastDay; d++){
    const dt = new Date(year, month-1, d);
    const dow = dt.getDay();
    const iso = dt.toISOString().split("T")[0];
    let cls = '';
    if (dow === 0) cls = 'sunday';
    else if (dow === 6) cls = 'saturday';
    if (holidays.has(iso)) cls = 'holiday';

    html += `<td class="${cls}">
      <div class="date">${d}æ—¥</div>
      <div class="hours">
        <input type="number" inputmode="decimal" step="0.25" min="0" placeholder="" data-day="${d}" class="hoursInput"> æ™‚é–“
      </div>
      <div class="small" style="margin-top:6px;">æ—¥æ–™é‡‘: <span id="fee-${d}">-</span> å††</div>
    </td>`;

    if (dt.getDay() === 6) html += '</tr><tr>';
  }

  // æœ€çµ‚è¡Œã®ç©ºã‚»ãƒ«
  const lastRowCells = (first.getDay() + lastDay) % 7;
  if (lastRowCells !== 0) {
    for(let i=lastRowCells;i<7;i++) html += '<td></td>';
    html += '</tr>';
  }

  html += '</tbody></table>';
  calendarDiv.innerHTML = html;

  // attach listeners to inputs
  calendarDiv.querySelectorAll('.hoursInput').forEach(inp=>{
    inp.addEventListener('input', calculateAll);
    // keep empty by default (user wanted empty inputs)
    inp.value = "";
  });

  // recalc
  calculateAll();
}

/* è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå»¶é•·æ–™é‡‘ã€è£œåŠ©ã€æœ€çµ‚æ”¯æ‰•ï¼‰ */
function calculateAll(){
  // read settings
  const hourlyRate = parseFloat(hourlyRateInput.value) || 0;
  const dailyCap = Number(dailyCapInput.value) || Infinity;
  const monthlyCapRaw = Number(monthlyCapInput.value) || 0; // 0 means unlimited
  const monthlyCap = monthlyCapRaw > 0 ? monthlyCapRaw : Infinity;
  const dailySubsidyCap = Number(dailySubsidyInput.value) || 0;
  const monthlySubsidyCap = Number(monthlySubsidyInput.value) || Infinity;

  let totalFees = 0;
  let totalSubsidies = 0;

  const inputs = Array.from(calendarDiv.querySelectorAll('.hoursInput'));
  inputs.forEach(inp=>{
    const day = inp.dataset.day;
    const hoursVal = inp.value.trim();
    const hours = hoursVal === "" ? 0 : parseFloat(hoursVal) || 0;
    let dayFee = hours * hourlyRate;
    if (dayFee > dailyCap) dayFee = dailyCap;
    // show day fee
    const feeEl = document.getElementById(`fee-${day}`);
    if (feeEl) feeEl.textContent = dayFee.toLocaleString();
    totalFees += dayFee;

    // subsidy per day = min(dayFee, dailySubsidyCap)
    const subsidy = Math.min(dayFee, dailySubsidyCap);
    totalSubsidies += subsidy;
  });

  // apply monthly caps
  if (totalFees > monthlyCap) totalFees = monthlyCap;
  if (totalSubsidies > monthlySubsidyCap) totalSubsidies = monthlySubsidyCap;

  let finalPayment = totalFees - totalSubsidies;
  if (finalPayment < 0) finalPayment = 0;

  totalFeeEl.textContent = `${Math.round(totalFees).toLocaleString()} å††`;
  totalSubsidyEl.textContent = `${Math.round(totalSubsidies).toLocaleString()} å††`;
  finalPaymentEl.textContent = `<strong>${Math.round(finalPayment).toLocaleString()} å††</strong>`;
}

/* å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆç”Ÿæˆ / èª­è¾¼ï¼‰ */
function generateCode(){
  const data = {
    month: monthInput.value,
    hourlyRate: hourlyRateInput.value || "",
    dailyCap: dailyCapInput.value || "",
    monthlyCap: monthlyCapInput.value || "",
    dailySubsidyCap: dailySubsidyInput.value || "",
    monthlySubsidyCap: monthlySubsidyInput.value || "",
    entries: {}
  };
  calendarDiv.querySelectorAll('.hoursInput').forEach(inp=>{
    if (inp.value.trim() !== "") data.entries[inp.dataset.day] = inp.value.trim();
  });
  const code = btoa(JSON.stringify(data));
  shareCodeInput.value = code;
  // also set bottom button to show code (copy-ready)
  alert('å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰æ¬„ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
}

/* è²¼ä»˜ã‘ã‹ã‚‰å¾©å…ƒï¼ˆshareCodeInput ã‚’ç·¨é›†ã—ã¦ã‹ã‚‰å‘¼ã¶ï¼‰ */
function loadFromShareInput(){
  const code = shareCodeInput.value.trim();
  if(!code) { alert("ã‚³ãƒ¼ãƒ‰ã‚’è²¼ä»˜ã‘ã¦ãã ã•ã„"); return; }
  loadFromCodeString(code);
}

/* ç›´æ¥ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‹ã‚‰å¾©å…ƒ */
function loadFromCodeString(code){
  try{
    const obj = JSON.parse(atob(code));
    if(obj.month) monthInput.value = obj.month;
    if(obj.hourlyRate !== undefined) hourlyRateInput.value = obj.hourlyRate;
    if(obj.dailyCap !== undefined) dailyCapInput.value = obj.dailyCap;
    if(obj.monthlyCap !== undefined) monthlyCapInput.value = obj.monthlyCap;
    if(obj.dailySubsidyCap !== undefined) dailySubsidyInput.value = obj.dailySubsidyCap;
    if(obj.monthlySubsidyCap !== undefined) monthlySubsidyInput.value = obj.monthlySubsidyCap;

    // redraw calendar for that month (and fetch holidays)
    renderForSelectedMonth().then(()=>{
      // fill entries
      if(obj.entries){
        Object.keys(obj.entries).forEach(day=>{
          const inp = calendarDiv.querySelector(`.hoursInput[data-day='${day}']`);
          if(inp) inp.value = obj.entries[day];
        });
      }
      calculateAll();
    });
  }catch(e){
    alert("ã‚³ãƒ¼ãƒ‰ãŒä¸æ­£ã§ã™");
    console.warn(e);
  }
}

/* ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ */
window.addEventListener('load', init);

/* å°ãƒ˜ãƒ«ãƒ‘ãƒ¼: æ—¢å®šå€¤å¾©å…ƒãƒœã‚¿ãƒ³ç”¨ */
function applyDefaultSettings(){ /* replaced earlier, but keep accessible */ }
</script>
</body>
</html>
