<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>保育園延長料金計算システム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f9f9f9;
      color: #333;
      font-size: 18px; /* 全体文字サイズを大きめに */
    }
    header {
      text-align: center;
      margin-bottom: 10px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .day {
      border: 1px solid #ccc;
      background: #fff;
      min-height: 80px;
      padding: 4px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 1rem;
    }
    .sunday { background-color: #ffe5e5; color: red; }
    .saturday { background-color: #e5f0ff; color: blue; }
    .holiday { background-color: #ffe5e5; color: red; }
    .day input {
      width: 90%;
      margin-top: 5px;
      padding: 6px;
      font-size: 1rem;
    }
    .cost {
      margin-top: 5px;
      font-size: 1rem;
      font-weight: bold;
    }
    #summary {
      margin-top: 20px;
      font-size: 1.1rem;
      line-height: 1.8;
    }
    #summary strong {
      font-size: 1.3rem;
      color: #000;
    }
    #settings, #share {
      display: none;
      margin-top: 15px;
      background: #fff;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #settings label, #share label {
      display: block;
      margin: 8px 0 4px;
      font-size: 1rem;
    }
    #settings input, #share input {
      width: 100%;
      padding: 6px;
      font-size: 1rem;
    }
    button {
      display: inline-block;
      padding: 10px 14px;
      margin: 8px 0;
      font-size: 1.1rem;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    button:active { background: #0056b3; }
    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      .day { min-height: 70px; font-size: 0.95rem; }
      .day input { font-size: 0.9rem; padding: 5px; }
      button { width: 100%; font-size: 1.1rem; padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>保育園延長料金計算システム</h1>
    <button onclick="toggleSettings()">⚙️ 設定</button>
    <button onclick="toggleShare()">🔗 共有コード</button>
  </header>

  <div id="calendar"></div>

  <div id="summary">
    <p>合計料金: <strong><span id="grossTotal">0</span> 円</strong></p>
    <p>補助額: <strong><span id="subsidyTotal">0</span> 円</strong></p>
    <p>自己負担額: <strong><span id="netTotal">0</span> 円</strong></p>
  </div>

  <div id="settings">
    <label>1時間あたり料金（円）</label>
    <input type="number" id="hourlyRate" value="250">
    <label>1日上限（円）</label>
    <input type="number" id="dailyCap" value="1250">
    <label>1か月上限（円）</label>
    <input type="number" id="monthlyCap" value="10000">
    <label>補助の日額上限（円）</label>
    <input type="number" id="dailySubsidyCap" value="450">
    <label>補助の月額上限（円）</label>
    <input type="number" id="monthlySubsidyCap" value="11260">
    <button onclick="saveSettings()">保存</button>
  </div>

  <div id="share">
    <label>共有コード</label>
    <input type="text" id="shareCodeInput" placeholder="共有コードを入力">
    <button onclick="applyShareCode()">コードを反映</button>
    <button onclick="generateShareCode()">コードを生成</button>
    <p id="generatedCode"></p>
  </div>

  <script>
    const apiKey = "AIzaSyBLeM4k58xXuKRqh9-tuLUCeOLjF2wkrM4"; // Google APIキーを設定
    const calendarId = "japanese__ja@holiday.calendar.google.com";
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    let holidays = [];
    let hourlyRate = 250, dailyCap = 1250, monthlyCap = 10000;
    let dailySubsidyCap = 450, monthlySubsidyCap = 11260;

    async function fetchHolidays() {
      const timeMin = new Date(year, month, 1).toISOString();
      const timeMax = new Date(year, month + 1, 0).toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}`;
      const response = await fetch(url);
      const data = await response.json();
      holidays = data.items.map(event => event.start.date);
      generateCalendar();
    }

    function generateCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      for (let date = 1; date <= lastDate; date++) {
        const cell = document.createElement("div");
        const day = new Date(year, month, date).getDay();
        const dateStr = new Date(year, month, date).toISOString().split("T")[0];
        cell.className = "day";
        if (day === 0) cell.classList.add("sunday");
        if (day === 6) cell.classList.add("saturday");
        if (holidays.includes(dateStr)) cell.classList.add("holiday");

        cell.innerHTML = `
          <div>${date}</div>
          <input type="number" min="0" placeholder="時間">
          <div class="cost"></div>
        `;
        calendar.appendChild(cell);

        const input = cell.querySelector("input");
        input.addEventListener("input", calculateTotal);
      }
    }

    function calculateTotal() {
      let grossTotal = 0, subsidyTotal = 0, netTotal = 0;

      document.querySelectorAll(".day").forEach(cell => {
        const input = cell.querySelector("input");
        const costDiv = cell.querySelector(".cost");
        const hours = parseFloat(input.value) || 0;

        let cost = hours * hourlyRate;
        if (cost > dailyCap) cost = dailyCap;

        let subsidy = Math.min(dailySubsidyCap, cost);
        let userCost = cost - subsidy;

        grossTotal += cost;
        subsidyTotal += subsidy;
        netTotal += userCost;

        costDiv.textContent = cost > 0 ? `${userCost}円` : "";
      });

      if (grossTotal > monthlyCap) grossTotal = monthlyCap;
      if (subsidyTotal > monthlySubsidyCap) subsidyTotal = monthlySubsidyCap;
      if (netTotal > monthlyCap) netTotal = monthlyCap; // 自己負担が月上限を超えないように

      document.getElementById("grossTotal").textContent = grossTotal;
      document.getElementById("subsidyTotal").textContent = subsidyTotal;
      document.getElementById("netTotal").textContent = netTotal;
    }

    function toggleSettings() {
      const s = document.getElementById("settings");
      s.style.display = s.style.display === "block" ? "none" : "block";
    }

    function saveSettings() {
      hourlyRate = parseInt(document.getElementById("hourlyRate").value) || 250;
      dailyCap = parseInt(document.getElementById("dailyCap").value) || 1250;
      monthlyCap = parseInt(document.getElementById("monthlyCap").value) || 10000;
      dailySubsidyCap = parseInt(document.getElementById("dailySubsidyCap").value) || 450;
      monthlySubsidyCap = parseInt(document.getElementById("monthlySubsidyCap").value) || 11260;
      alert("設定を保存しました");
      calculateTotal();
    }

    function toggleShare() {
      const s = document.getElementById("share");
      s.style.display = s.style.display === "block" ? "none" : "block";
    }

    function generateShareCode() {
      const inputs = Array.from(document.querySelectorAll(".day input")).map(i => i.value || "0");
      const code = inputs.join(",");
      document.getElementById("generatedCode").textContent = "生成コード: " + code;
    }

    function applyShareCode() {
      const code = document.getElementById("shareCodeInput").value.trim();
      if (!code) return;
      const values = code.split(",");
      const inputs = document.querySelectorAll(".day input");
      values.forEach((val, i) => { if (inputs[i]) inputs[i].value = val; });
      calculateTotal();
    }

    fetchHolidays();
  </script>
</body>
</html>
