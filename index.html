<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>保育園延長料金計算システム</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
      text-align: center;
      font-size: 20px; /* 全体をさらに大きく */
    }
    h1 { font-size: 28px; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      font-size: 20px;
    }
    .saturday { background-color: #e0f7fa; }
    .sunday, .holiday { background-color: #ffebee; }
    .inputs input { width: 80px; font-size: 20px; text-align: right; }
    .settings { display: none; margin: 15px 0; font-size: 18px; }
    .results {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    .toggle-btn, .gen-btn {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 18px;
      border-radius: 8px;
    }
    .code-box {
      display: none;
      margin-top: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>保育園延長料金計算システム</h1>

  <div>
    年: <input type="number" id="yearInput" style="width:100px; font-size:20px;">
    月: <input type="number" id="monthInput" style="width:60px; font-size:20px;">
    <button onclick="generateCalendar()">表示</button>
  </div>

  <button class="toggle-btn" onclick="toggleSettings()">⚙️ 設定を表示/非表示</button>
  <div class="settings" id="settings">
    1時間あたり料金: <input type="number" id="hourlyRate" value="250"><br>
    1日上限: <input type="number" id="dailyCap" value="1250"><br>
    1か月上限: <input type="number" id="monthlyCap" value="10000"><br>
    補助の日額上限: <input type="number" id="subsidyDaily" value="450"><br>
    補助の月額上限: <input type="number" id="subsidyMonthly" value="11260"><br>
  </div>

  <table id="calendar"></table>

  <div class="results" id="results"></div>

  <button class="gen-btn" onclick="generateCode()">共有コードを生成</button>
  <div class="code-box" id="codeBox">
    <input type="text" id="shareCode" readonly style="width:80%; font-size:18px;">
    <button onclick="loadCode()">読み込み</button>
  </div>

  <script>
    const calendarEl = document.getElementById("calendar");
    const resultsEl = document.getElementById("results");
    const holidays = new Set();

    async function fetchHolidays(year) {
      holidays.clear();
      const calendarId = "japanese__ja@holiday.calendar.google.com";
      const apiKey = "AIzaSyBLeM4k58xXuKRqh9-tuLUCeOLjF2wkrM4"; // 差し替え
      const timeMin = `${year}-01-01T00:00:00Z`;
      const timeMax = `${year}-12-31T23:59:59Z`;
      const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&maxResults=150&orderBy=startTime&singleEvents=true`;
      const res = await fetch(url);
      const data = await res.json();
      data.items.forEach(ev => holidays.add(ev.start.date));
    }

    function toggleSettings() {
      const s = document.getElementById("settings");
      s.style.display = s.style.display === "none" ? "block" : "none";
    }

    function generateCalendar() {
      const year = parseInt(document.getElementById("yearInput").value);
      const month = parseInt(document.getElementById("monthInput").value);
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0).getDate();

      let html = "<tr>";
      ["日","月","火","水","木","金","土"].forEach(d => html += `<th>${d}</th>`);
      html += "</tr><tr>";

      for (let i = 0; i < firstDay.getDay(); i++) html += "<td></td>";

      for (let day = 1; day <= lastDay; day++) {
        const date = new Date(year, month - 1, day);
        const dayStr = date.toISOString().split("T")[0];
        let cls = "";
        if (date.getDay() === 0) cls = "sunday";
        else if (date.getDay() === 6) cls = "saturday";
        if (holidays.has(dayStr)) cls = "holiday";

        html += `<td class="${cls}">${day}<br>
          <input type="text" 
            inputmode="decimal" 
            pattern="[0-9]*[.]?[0-9]*" 
            id="d${day}" 
            oninput="calculate()">
          <div id="p${day}"></div>
        </td>`;

        if (date.getDay() === 6) html += "</tr><tr>";
      }
      html += "</tr>";
      calendarEl.innerHTML = html;
    }

    function calculate() {
      const hourlyRate = parseFloat(document.getElementById("hourlyRate").value);
      const dailyCap = parseFloat(document.getElementById("dailyCap").value);
      const monthlyCap = parseFloat(document.getElementById("monthlyCap").value);
      const subsidyDaily = parseFloat(document.getElementById("subsidyDaily").value);
      const subsidyMonthly = parseFloat(document.getElementById("subsidyMonthly").value);

      let total = 0, subsidy = 0;
      for (let day = 1; day <= 31; day++) {
        const input = document.getElementById(`d${day}`);
        const priceEl = document.getElementById(`p${day}`);
        if (!input) continue;
        const hours = parseFloat(input.value) || 0;
        let fee = Math.min(hours * hourlyRate, dailyCap);
        let sub = Math.min(fee, subsidyDaily);
        total += fee;
        subsidy += sub;
        priceEl.innerText = fee > 0 ? `${fee}円` : "";
      }
      total = Math.min(total, monthlyCap);
      subsidy = Math.min(subsidy, subsidyMonthly);
      const selfPay = total - subsidy;

      resultsEl.innerHTML =
        `合計料金: ${total} 円<br>` +
        `補助額: ${subsidy} 円<br>` +
        `自己負担額: ${selfPay} 円`;
    }

    function generateCode() {
      let data = {};
      ["hourlyRate","dailyCap","monthlyCap","subsidyDaily","subsidyMonthly"].forEach(id=>{
        data[id] = document.getElementById(id).value;
      });
      const year = document.getElementById("yearInput").value;
      const month = document.getElementById("monthInput").value;
      data["year"] = year;
      data["month"] = month;
      data["days"] = [];
      for (let day = 1; day <= 31; day++) {
        const input = document.getElementById(`d${day}`);
        if (input) data["days"].push(input.value);
      }
      const code = btoa(JSON.stringify(data));
      document.getElementById("shareCode").value = code;
      document.getElementById("codeBox").style.display = "block";
    }

    function loadCode() {
      const code = document.getElementById("shareCode").value;
      try {
        const data = JSON.parse(atob(code));
        ["hourlyRate","dailyCap","monthlyCap","subsidyDaily","subsidyMonthly"].forEach(id=>{
          document.getElementById(id).value = data[id];
        });
        document.getElementById("yearInput").value = data["year"];
        document.getElementById("monthInput").value = data["month"];
        generateCalendar();
        data["days"].forEach((val, idx)=>{
          const input = document.getElementById(`d${idx+1}`);
          if (input) input.value = val;
        });
        calculate();
      } catch(e) { alert("コードが不正です"); }
    }

    (async function init() {
      const now = new Date();
      document.getElementById("yearInput").value = now.getFullYear();
      document.getElementById("monthInput").value = now.getMonth()+1;
      await fetchHolidays(now.getFullYear());
      generateCalendar();
    })();
  </script>
</body>
</html>
