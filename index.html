<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>保育園延長料金計算システム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      font-size: 20px;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      font-size: 20px;
      word-wrap: break-word;
    }
    td input {
      width: 100%;
      font-size: 20px;
      text-align: right;
      box-sizing: border-box;
    }
    .saturday { background-color: #e0f0ff; }
    .sunday   { background-color: #ffe0e0; }
    .holiday  { background-color: #ffcccc; }
    .settings { display: none; margin: 10px 0; }
    .settings label { margin-right: 10px; }
    .result {
      margin-top: 15px;
      font-size: 22px;
    }
    .share {
      margin-top: 20px;
      text-align: center;
    }
    button {
      font-size: 20px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>保育園延長料金計算システム</h1>

  <div>
    年: <input type="number" id="year" style="font-size:20px; width:100px;">
    月: <input type="number" id="month" style="font-size:20px; width:80px;">
    <button onclick="renderCalendar()">表示</button>
  </div>

  <div>
    <button onclick="toggleSettings()">⚙ 設定を表示/非表示</button>
    <div class="settings" id="settings">
      <label>1時間あたり料金 <input type="number" id="rate" value="250"></label>
      <label>1日上限 <input type="number" id="dailyMax" value="1250"></label>
      <label>1か月上限 <input type="number" id="monthlyMax" value="10000"></label>
      <label>補助（日額上限） <input type="number" id="subsidyDailyMax" value="450"></label>
      <label>補助（月額上限） <input type="number" id="subsidyMonthlyMax" value="11260"></label>
    </div>
  </div>

  <table id="calendar"></table>

  <div class="result">
    <p>合計料金: <span id="totalFee">0</span> 円</p>
    <p>補助額: <span id="subsidyAmount">0</span> 円</p>
    <p>自己負担額: <span id="finalFee">0</span> 円</p>
  </div>

  <div class="share">
    <button onclick="generateShareCode()">共有コードを生成</button>
    <p id="shareCode"></p>
  </div>

  <script>
    const apiKey = "AIzaSyBLeM4k58xXuKRqh9-tuLUCeOLjF2wkrM4";
    const holidayCalendarId = "japanese__ja@holiday.calendar.google.com";
    let holidays = {};

    function toggleSettings() {
      const s = document.getElementById("settings");
      s.style.display = (s.style.display === "none") ? "block" : "none";
    }

    async function fetchHolidays(year, month) {
      const timeMin = new Date(year, month - 1, 1).toISOString();
      const timeMax = new Date(year, month, 0, 23, 59, 59).toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${holidayCalendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}`;
      const res = await fetch(url);
      const data = await res.json();
      holidays = {};
      if (data.items) {
        data.items.forEach(event => {
          if (event.start && event.start.date) {
            const dateStr = event.start.date; // YYYY-MM-DD 文字列
            holidays[dateStr] = event.summary;
          }
        });
      }
    }

    function calculateTotal() {
      const rate = parseFloat(document.getElementById("rate").value) || 0;
      const dailyMax = parseFloat(document.getElementById("dailyMax").value) || Infinity;
      const monthlyMax = parseFloat(document.getElementById("monthlyMax").value) || Infinity;
      const subsidyDailyMax = parseFloat(document.getElementById("subsidyDailyMax").value) || 0;
      const subsidyMonthlyMax = parseFloat(document.getElementById("subsidyMonthlyMax").value) || 0;

      const inputs = document.querySelectorAll("#calendar input");
      let total = 0;
      let subsidyTotal = 0;

      inputs.forEach(input => {
        const hours = parseFloat(input.value) || 0;
        let fee = hours * rate;
        if (fee > dailyMax) fee = dailyMax;
        total += fee;

        let subsidy = Math.min(fee, subsidyDailyMax);
        subsidyTotal += subsidy;
      });

      if (total > monthlyMax) total = monthlyMax;
      if (subsidyTotal > subsidyMonthlyMax) subsidyTotal = subsidyMonthlyMax;

      const finalFee = Math.max(total - subsidyTotal, 0); // マイナス防止

      document.getElementById("totalFee").innerText = total.toFixed(0);
      document.getElementById("subsidyAmount").innerText = subsidyTotal.toFixed(0);
      document.getElementById("finalFee").innerText = finalFee.toFixed(0);
    }

    function generateShareCode() {
      const inputs = Array.from(document.querySelectorAll("#calendar input")).map(i => i.value);
      const settings = [
        document.getElementById("rate").value,
        document.getElementById("dailyMax").value,
        document.getElementById("monthlyMax").value,
        document.getElementById("subsidyDailyMax").value,
        document.getElementById("subsidyMonthlyMax").value,
      ];
      const code = btoa(JSON.stringify({ inputs, settings }));
      document.getElementById("shareCode").innerText = code;
    }

    function loadFromShareCode(code) {
      try {
        const data = JSON.parse(atob(code));
        const inputs = document.querySelectorAll("#calendar input");
        inputs.forEach((input, idx) => input.value = data.inputs[idx] || "");
        [ "rate","dailyMax","monthlyMax","subsidyDailyMax","subsidyMonthlyMax" ]
          .forEach((id, idx) => document.getElementById(id).value = data.settings[idx]);
        calculateTotal();
      } catch (e) { alert("無効な共有コードです"); }
    }

    async function renderCalendar() {
      const year = parseInt(document.getElementById("year").value);
      const month = parseInt(document.getElementById("month").value);
      await fetchHolidays(year, month);

      const firstDay = new Date(year, month - 1, 1).getDay();
      const daysInMonth = new Date(year, month, 0).getDate();
      const table = document.getElementById("calendar");
      table.innerHTML = "";

      let header = "<tr>";
      ["日","月","火","水","木","金","土"].forEach(d => header += "<th>"+d+"</th>");
      header += "</tr>";
      table.innerHTML = header;

      let row = "<tr>";
      for (let i = 0; i < firstDay; i++) row += "<td></td>";

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month - 1, d);
        const dateStr = date.toISOString().split("T")[0];
        let cls = "";
        if (date.getDay() === 0) cls = "sunday";
        if (date.getDay() === 6) cls = "saturday";
        if (holidays[dateStr]) cls = "holiday";

        row += `<td class="${cls}">${d}<br><input type="number" step="0.1" min="0" oninput="calculateTotal()"></td>`;
        if (date.getDay() === 6) { row += "</tr>"; table.innerHTML += row; row = "<tr>"; }
      }
      if (row !== "<tr>") row += "</tr>", table.innerHTML += row;

      calculateTotal();
    }

    window.onload = () => {
      const today = new Date();
      document.getElementById("year").value = today.getFullYear();
      document.getElementById("month").value = today.getMonth() + 1;
      renderCalendar();
    };
  </script>
</body>
</html>
